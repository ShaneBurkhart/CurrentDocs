<% content_for :title, "Billing Info" %>
<%= content_for :head, '<script type="text/javascript" src="https://js.stripe.com/v2/"></script>'.html_safe %>
<div class="container">
  <h1 class="text-center">Enter Your Billing Information</h1>
  <br>
  <div class="row">
    <div class="span6 offset3">

      <%= simple_form_for(@user, url: subscription_billing_path, :html => {id: "card-form", :class => 'card_form form-vertical' }) do |f| %>
        <div class="payment-errors text-error">
          <%= f.error_notification %>
          <%= display_base_errors @user %>
        </div>
        <h3>Credit Card Information</h3>
        <div class="row-fluid">
          <div class="span10">
            <%= label_tag :card_number, "Credit Card Number" %>
            <%= text_field_tag :card_number, nil, name: nil, class: "input-block-level", "data-stripe" => "number" %>
          </div>
          <div class="span2">
            <%= label_tag :card_code, "CVV" %>
            <%= text_field_tag :card_code, nil, name: nil, class: "input-block-level", "data-stripe" => "cvc" %>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span12">
            <%= label_tag :card_month, "Card Expiration" %>
          </div>
        </div>
        <div class="row-fluid">
          <div class="span6">
            <%= select_month nil, { add_month_numbers: true }, { name: nil, id: "card_month", class: "input-block-level", "data-stripe" => "exp-month"} %>
          </div>
          <div class="span6">
            <%= select_year nil, {start_year: Date.today.year, end_year: Date.today.year+10}, {name: nil, id: "card_year", class: "input-block-level", "data-stripe" => "exp-year"} %>
          </div>
        </div>
        <%= f.hidden_field :stripe_customer_id %>
        <div class="row-fluid">
          <div class="span12">
            <%= f.button :submit, 'Sign Up', :class => "button button-blue " %>
          </div>
        </div>
      <% end %>

    </div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function(){
    Stripe.setPublishableKey('pk_test_6vqiZSCYvabg0MF07Wa9lcf3');

    var stripeResponseHandler = function(status, response) {
      var $form = $('#card-form');

      if (response.error) {
        // Show the errors on the form
        $form.find('.payment-errors').text(response.error.message).parent().show();
        $form.find('input[type="submit"]').prop('disabled', false);
      } else {
        // token contains id, last4, and card type
        var token = response.id;
        // Insert the token into the form so it gets submitted to the server
        $form.find("#user_stripe_customer_id").val(token);
        // and submit
        $form.get(0).submit();
      }
    };

    var isValid = function(form){
      var error = form.find(".payment-errors");
      var msg = "";

      if(msg != ""){
        error.text(msg).parent().show();
        return false;
      }
      return true;
    };

    $('#card-form').submit(function(event) {
      var $form = $(this);

      if(isValid($form)){
        // Disable the submit button to prevent repeated clicks
        $form.find('input[type="submit"]').prop('disabled', true);

        Stripe.createToken($form, stripeResponseHandler);
      }

      // Prevent the form from submitting with the default action
      return false;
    });
  });

</script>
