<% content_for :title, "Billing Info" %>
<%= content_for :head, '<script type="text/javascript" src="https://js.stripe.com/v2/"></script>'.html_safe %>
<div class="container">
  <h1>Enter Your Billing Information</h1>
  <div class="row">
    <div class="span6 offset3">

      <%= form_tag account_billing_path, method: :post, id: "payment-form" do %>
        <div class="alert alert-error" style="display:none;">
          <%= content_tag :div, "", class: "payment-errors" %>
        </div>

        <div class="row-fluid">
          <div class="span4 text-right">
            Name On Card:
          </div>
          <div class="span8">
            <input type="text" class="input-block-level" size="20" placeholder="Name" data-stripe="name"/>
          </div>
        </div>

        <div class="row-fluid">
          <div class="span4 text-right">
            Address:
          </div>
          <div class="span8">
            <input type="text" class="input-block-level" placeholder="Street Address" data-stripe="address_line1"/>
          </div>
        </div>

        <div class="row-fluid">
          <div class="span8 offset4">
            <input type="text" class="input-block-level" placeholder="Apartment, Suite, Bldg., etc. (optional)" data-stripe="address_line2"/>
          </div>
        </div>

        <div class="row-fluid">
          <div class="span5 offset4">
            <input type="text" class="input-block-level" placeholder="City" data-stripe="address_city"/>
          </div>
          <div class="span3">
            <input type="text" class="input-block-level" placeholder="Zipcode" data-stripe="address_zip"/>
          </div>
        </div>

        <div class="row-fluid">
          <div class="span8 offset4">
            <input type="text" class="input-block-level" placeholder="State/Region/Province" data-stripe="address_state"/>
          </div>
        </div>

        <div class="row-fluid">
          <div class="span12">
            <div class="alert alert-info">
              <%= content_tag :div, "We will not charge your card during your free trial!" %>
            </div>
          </div>
        </div>

        <div class="row-fluid">
          <div class="span4 text-right">
            Credit Card Number:
          </div>
          <div class="span6">
            <input type="text" class="input-block-level" size="20" placeholder="Card Number" data-stripe="number"/>
          </div>
          <div class="span2">
            <input type="text" class="input-block-level" size="4" placeholder="CVC" data-stripe="cvc"/>
          </div>
        </div>

        <div class="row-fluid">
          <div class="span4 text-right">
            Expiration Date:
          </div>
          <div class="span4">
            <%= select nil, nil, exp_months, {include_blank: 'Month'}, class: "input-block-level", data: { stripe: "exp-month" } %>
          </div>
          <div class="span4">
            <%= select nil, nil, exp_years, {include_blank: 'Year'}, class: "input-block-level", data: { stripe: "exp-year" } %>
          </div>
        </div>

        <div class="row-fluid">
          <div class="span8 offset4 text-center">
            <button type="submit" class="button button-green button-tall button-wide">Start Free Trial</button>
          </div>
        </div>
      <% end %>

    </div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function(){
    Stripe.setPublishableKey('pk_test_aRHL7CefYn1FjAjpDgIGVtuE');

    var stripeResponseHandler = function(status, response) {
      var $form = $('#payment-form');

      if (response.error) {
        // Show the errors on the form
        $form.find('.payment-errors').text(response.error.message).parent().show();
        $form.find('button').prop('disabled', false);
      } else {
        // token contains id, last4, and card type
        var token = response.id;
        // Insert the token into the form so it gets submitted to the server
        $form.append($('<input type="hidden" name="stripeToken" />').val(token));
        // and submit
        $form.get(0).submit();
      }
    };

    var isValid = function(form){
      var error = form.find(".payment-errors");
      var msg = "";

      if(msg != ""){
        error.text(msg).parent().show();
        return false;
      }
      return true;
    };

    $('#payment-form').submit(function(event) {
      var $form = $(this);

      if(isValid($form)){
        // Disable the submit button to prevent repeated clicks
        $form.find('button').prop('disabled', true);

        Stripe.createToken($form, stripeResponseHandler);
      }

      // Prevent the form from submitting with the default action
      return false;
    });
  });

</script>